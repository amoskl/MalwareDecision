import os
import pickle
import time

from ngram.ngram import NgramFromFoldersBuilder
from ngram_classificaiton.classification_methodology import FileReader
from decision_tree.decisiontree import DecisionTree


class TreeBuilder(object):
    TREE_FILE_NAME_PREFIX = "tree_"
    TREE_IMAGE_NAME_PREFIX = "img_tree_"
    NGRAMS_FILE_NAME = "out.txt"  # DO NOT CHANGE!!!!

    def __init__(self, experiment_runner):
        self.experiment_runner = experiment_runner
        self.most_informative_ngrams = None

    def build(self):
        start_time = time.time()

        self._build_ngrams_file()
        self._calculate_most_informative_ngrams()
        self._build_tree()

        end_time = time.time()

        print "it took {time} seconds".format(time=end_time - start_time)

    def _build_ngrams_file(self):
        ngram_builder = NgramFromFoldersBuilder(self.experiment_runner)
        ngram_builder.build()

    def _calculate_most_informative_ngrams(self):
        file_reader = FileReader(os.path.join(self.experiment_runner.out_folder,
                                              self.NGRAMS_FILE_NAME),
                                 self.experiment_runner)
        file_reader.read_ngrams()
        most_informative_ngrams = file_reader.get_most_informative_ngrams()
        self.most_informative_ngrams = most_informative_ngrams

    def _build_tree(self):
        tree = DecisionTree(self.most_informative_ngrams, self.experiment_runner)

        tree_img_file_path = os.path.join(self.experiment_runner.out_folder,
                                          self.TREE_IMAGE_NAME_PREFIX +
                                          self.experiment_runner.name +
                                          ".dot")
        tree.draw_tree(tree_img_file_path)

        tree_file_path = os.path.join(self.experiment_runner.out_folder,
                                      self.TREE_FILE_NAME_PREFIX +
                                      self.experiment_runner.name)
        pickle.dump(tree, open(tree_file_path, "wb"))

        return tree_file_path
