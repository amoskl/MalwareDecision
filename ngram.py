import subprocess
import os
import time


class NgramFromFoldersBuilder(object):
    _NGRAMS_BUILDER = "ngrams"
    _CURRENT_DIR = os.path.dirname(__file__)

    def __init__(self, n, malware_folder_path, benign_folder_path, output_path):
        self._n = n
        self._malware_folder_path = malware_folder_path
        self._benign_folder_path = benign_folder_path
        self._output_path = output_path

    def build(self):
        print os.path.join(self._CURRENT_DIR, self._NGRAMS_BUILDER)

        args = [os.path.join(self._CURRENT_DIR,
                             self._NGRAMS_BUILDER),
                str(self._n),
                self._benign_folder_path,
                self._malware_folder_path,
                self._output_path]
        subprocess.call(args)


class NgramFromFileBuilder(object):

    def __init__(self, n):
        self._n = n

    def _get_ngram_from_buffer(self, ngram_buffer):
            for i in xrange(len(ngram_buffer) - self._n + 1):
                ngram = ngram_buffer[i: i + self._n]
                yield ngram

    def get_ngrams_from_single_file(self, file_path):
        print "Reading ngrams from file:{file}".format(file=os.path.basename(file_path))
        ngrams = set()

        with open(file_path, 'rb') as current_file:
            ngram_buffer = current_file.read()

            cur_time = time.time()

            for ngram in self._get_ngram_from_buffer(ngram_buffer):
                ngrams.add(ngram)

            print "Read {ngrams} new ngrams from {file} in {seconds} seconds.".format(ngrams=len(ngrams),
                                                                                      file=os.path.basename(file_path),
                                                                                      seconds=(time.time()-cur_time))
            return ngrams